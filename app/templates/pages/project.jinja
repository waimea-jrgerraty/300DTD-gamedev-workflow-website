{#=====================================================
  Home page
  - Hero style greeting banner
  - List of things passed in as 'things' array
  - Form for adding a new thing
=====================================================#}
{% extends "pages/base.jinja" %}
{% block title %}
    TaskForge - {{ project.name }}
{% endblock title %}
{% block nav_left %}
    {% if project.owner == session.userid %}
        <li>
            <button id="p-open-add-user" data-project-id="{{ project.id }}">
                <span class="material-symbols-outlined">group_add</span>
            </button>
        </li>
        <dialog id="p-add-user-modal">
            <article>
                <header>
                    <h3>Add user to project</h3>
                </header>
                <input id="p-member-input"
                       type="text"
                       placeholder="Type a username..."
                       autocomplete="off">
                <output id="p-add-user-error" role="status"></output>
                <footer>
                    <button id="p-cancel-add-user" class="secondary">Cancel</button>
                    <button id="p-confirm-add-user">Add</button>
                </footer>
            </article>
        </dialog>
        <script src="{{ url_for('static', filename='js/project_add_user_modal.js') }}"></script>
    {% endif %}
{% endblock nav_left %}
{% block nav_centre %}
    <li>
        <h3>
            <span class="weak">{{ project.name }}</span>
        </h3>
    </li>
{% endblock nav_centre %}
{% macro render_task(task, project, category, completed=False) %}
    {% if task.id %}
        <a class="task {% if completed %}completed{% endif %}"
           href="/project/{{ project.id }}/category/{{ category.id }}/task/{{ task.id }}">
            <article class="priority-{{ task.priority }}">
                <h3>{{ task.name }}</h3>
                <div class="taskFooter">
                    <div role="group">
                        {% if task.description %}<span class="material-symbols-outlined" title="Has Description">description</span>{% endif %}
                        <div class="userIcons">
                            {% set users = task.assigned_users | from_json %}
                            {% if users %}
                                {% for user in users[:3] %}
                                    <a href="/user/{{ user.id }}/profile" data-tooltip="{{ user.username }}">
                                        <img src="/user/{{ user.id }}/icon"
                                             alt="{{ user.username }}"
                                             class="user-icon"
                                             height="64"
                                             width="64"
                                             aria-label="{{ user.username }}">
                                    </a>
                                {% endfor %}
                                {% if users|length > 3 %}<span class="ellipsis">…</span>{% endif %}
                            {% else %}
                                <span class="no-users">No users assigned</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </article>
        </a>
    {% endif %}
{% endmacro %}
{% block content %}
    {# New task form #}
    <button id="openModalBtn" class="floating-button">
        <span class="material-symbols-outlined">add_2</span>
    </button>
    <div id="projectModal" class="modal glass">
        <div class="modal-content">
            <span id="closeModalBtn" class="close-button">×</span>
            <h2>Create New Task</h2>
            <form action="/task" method="post">
                <input type="hidden" name="project" value="{{ project.id }}">
                <input type="hidden" name="category" value="{{ category.id }}">
                <label for="group">Task Group</label>
                <select id="group" name="group" required>
                    {% for group in groups %}<option value="{{ group.group_id }}">{{ group.group_name }}</option>{% endfor %}
                </select>
                <label for="taskName">
                    Task Name <span class="required">*</span>
                </label>
                <input type="text" id="taskName" name="name" autocomplete="off" required>
                <label for="description">Description</label>
                <textarea id="description" name="description" rows="4" placeholder="..."></textarea>
                <label for="priority">
                    Priority <span class="required">*</span>
                </label>
                <select name="priority" id="priority" aria-label="Priority">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option selected value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                </select>
                <label for="dueDate">Due Date</label>
                <input type="date" id="dueDate" name="deadline">
                <button type="submit" class="submit-btn">Create</button>
            </form>
        </div>
    </div>
    <script src="{{ url_for('static', filename='js/modal.js') }}"></script>
    <script src="{{ url_for('static', filename='js/edit_taskgroup.js') }}"></script>
    <div id="main">
        <div id="categories">
            {% for cat in categories %}
                <a class="category-button {% if cat.id == category.id %}selected{% endif %}"
                   href="/project/{{ project.id }}/category/{{ cat.id }}">{{ cat.name }}</a>
            {% endfor %}
        </div>
        <div id="taskPanel">
            {% for group in groups %}
                {% set tasks = group.tasks | from_json %}
                <article class="group">
                    <header>
                        <h2>
                            <input type="text"
                                   class="editable-group-name"
                                   value="{{ group.group_name }}"
                                   data-group-id="{{ group.group_id }}">
                        </h2>
                    </header>
                    {% if tasks %}
                        {% set active_tasks = tasks | selectattr('completed_timestamp', 'equalto', None) | list %}
                        {% set completed_tasks = tasks | selectattr('completed_timestamp') | list %}
                        {# Render active tasks #}
                        {% for task in active_tasks %}{{ render_task(task, project, category) }}{% endfor %}
                        {# Render completed tasks in collapsible section #}
                        {% if completed_tasks %}
                            <details class="completed-tasks">
                                <summary>Completed Tasks ({{ completed_tasks | length }})</summary>
                                <div class="completed-tasks-list">
                                    {% for task in completed_tasks %}{{ render_task(task, project, category, completed=True) }}{% endfor %}
                                </div>
                            </details>
                        {% endif %}
                    {% endif %}
                </article>
            {% endfor %}
            {# New group button #}
            <button id="addGroupBtn"
                    class="add-group-btn"
                    data-project-id="{{ project.id }}"
                    data-category-id="{{ category.id }}">＋</button>
        </div>
    </div>
{% endblock content %}
